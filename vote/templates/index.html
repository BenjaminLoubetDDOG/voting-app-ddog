<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>{{option_a}} vs {{option_b}}!</title>
    <base href="/index.html">
    <meta name = "viewport" content = "width=device-width, initial-scale = 1.0">
    <meta name="keywords" content="docker-compose, docker, stack">
    <meta name="author" content="Tutum dev team">
    <link rel='stylesheet' href="{{ url_for('static',filename='stylesheets/style.css') }}" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Datadog RUM -->
    <script>
      (function(h,o,u,n,d) {
        h=h[d]=h[d]||{q:[],onReady:function(c){h.q.push(c)}}
        d=o.createElement(u);d.async=1;d.src=n
        n=o.getElementsByTagName(u)[0];n.parentNode.insertBefore(d,n)
      })(window,document,'script','https://www.datadoghq-browser-agent.com/us1/v6/datadog-rum.js','DD_RUM')
      window.DD_RUM.onReady(function() {
        window.DD_RUM.init({
          clientToken: 'pube3da80f5045f15b082baffe60e94bafe',
          applicationId: 'a5224e3e-8314-49dc-99ab-c0bfdc455f0d',
          // `site` refers to the Datadog site parameter of your organization
          // see https://docs.datadoghq.com/getting_started/site/
          site: 'datadoghq.com',
          service: 'vote',
          env: 'demo',
          allowedTracingUrls: [
            'http://localhost:8080/',
            'http://localhost:8080',
            '/',
            { match: /.*/, propagatorTypes: ['datadog'] }
          ],
          // Specify a version number to identify the deployed version of your application in Datadog
          // version: '1.0.0',
          sessionSampleRate: 100,
          sessionReplaySampleRate: 100,
          defaultPrivacyLevel: 'mask-user-input',
          // Essential for RUM/APM correlation
          trackResources: true,
          trackLongTasks: true,
          trackUserInteractions: true,
        });
      })
    </script>
  </head>
  <body>
    <div id="content-container">
      <div id="content-container-center">
        <h3>{{option_a}} vs {{option_b}}!</h3>
        <form id="choice" name='form' method="POST" action="/">
          <button id="a" type="submit" name="vote" class="a" value="a">{{option_a}}</button>
          <button id="b" type="submit" name="vote" class="b" value="b">{{option_b}}</button>
        </form>
        <div id="tip">
          (Tip: you can change your vote)
        </div>
        <div id="hostname">
          Processed by container ID {{hostname}}
        </div>
      </div>
    </div>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script>
      $(document).ready(function() {
        // Store option names from the page for later use
        var optionA = $(".a").text().trim();
        var optionB = $(".b").text().trim();
        
        // Handle form submission with AJAX for RUM/APM correlation
        $('#choice').on('submit', function(e) {
          e.preventDefault(); // Prevent traditional form submission
          
          var clickedButton = $(document.activeElement);
          var vote = clickedButton.val();
          
          // Use fetch() so RUM can inject correlation headers
          console.log('Submitting vote:', vote);
          console.log('RUM initialized:', !!window.DD_RUM);
          
          // Ensure RUM is ready before making the request
          if (window.DD_RUM && window.DD_RUM.getInitConfiguration) {
            console.log('RUM config:', window.DD_RUM.getInitConfiguration());
          }
          
          fetch('/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'vote=' + vote
          })
          .then(response => response.text())
          .then(data => {
            // Update UI after successful vote
            updateVoteDisplay(vote);
          })
          .catch(error => {
            console.error('Vote submission failed:', error);
          });
        });
        
        function updateVoteDisplay(vote) {
          // Reset both buttons first
          $(".a").prop('disabled', false).css('opacity', '1');
          $(".b").prop('disabled', false).css('opacity', '1');
          
          if(vote == "a"){
            $(".a").prop('disabled', true);
            $(".a").html(optionA + ' <i class="fa fa-check-circle"></i>');
            $(".b").css('opacity','0.5');
          }
          if(vote == "b"){
            $(".b").prop('disabled', true);
            $(".b").html(optionB + ' <i class="fa fa-check-circle"></i>');
            $(".a").css('opacity','0.5');
          }
        }
      });
    </script>

    {% if vote %}
    <script>
      // Initial vote display if page loads with existing vote
      var vote = "{{vote}}";
      if(vote == "a"){
        $(".a").prop('disabled', true);
        $(".a").html('{{option_a}} <i class="fa fa-check-circle"></i>');
        $(".b").css('opacity','0.5');
      }
      if(vote == "b"){
        $(".b").prop('disabled', true);
        $(".b").html('{{option_b}} <i class="fa fa-check-circle"></i>');
        $(".a").css('opacity','0.5');
      }
    </script>
    {% endif %}
  </body>
</html>
